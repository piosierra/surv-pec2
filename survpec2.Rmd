---
title: "Análisis de Supervivencia PEC2"
author: "Pío Sierra"
date: "17/5/2020"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
if (!(require(survival)))
  install.packages("survival")
```

Variable       |   Description                |     Codes / Values
---------------|------------------------------|------------------------
id             |   Identification Code        |     1 - 500
age            |  Age at Hospital Admission   |    Years
gender         |   Gender                     |     0 = Male, 1 = Female
hr             |   Initial Heart Rate         |     Beats per minute
sysbp          |   Initial Systolic Blood Pressure     |    mmHg
diasbp         |   Initial Diastolic Blood Pressure   |     mmHg
bmi            |   Body Mass Index             |    kg/m^2
cvd            |   History of Cardiovascular Disease  |    0 = No, 1 = Yes
afb            |   Atrial Fibrillation         |    0 = No, 1 = Yes
sho             |  Cardiogenic Shock      |         0 = No, 1 = Yes
chf            |   Congestive Heart Complications     |          0 = No, 1 = Yes
av3            |   Complete Heart Block   |         0 = No, 1 = Yes
miord          |   MI Order                |        0 = First, 1 = Recurrent
mitype         |   MI Type                |         0 = non Q-wave, 1 = Q-wave
year           |  Cohort Year             |        1 = 1997, 2 = 1999, 3 = 2001
admitdate      |   Hospital Admission Date |        mm/dd/yyyy
disdate        |   Hospital Discharge Date  |       mm/dd/yyyy
fdate          |   Date of last Follow Up    |      mm/dd/yyyy
los            |   Length of Hospital Stay   |      Days between Hospital Discharge and Hospital Admission
dstat          |   Discharge Status fromHospital  |       0 = Alive, 1 = Dead
lenfol         |   Total Length of Follow-up   |    Days between Date of Last Follow-up and Hospital Admission Date
fstat          |   Vital Status at Last Follow-up     |      0 = Alive 1 = Dead
                     
***   

# Lectura y preparación de datos

```{r}
data <- read.table("../Second-Edition Data/whas500.dat")
colnames(data) <- c("id", "age", "gender", "hr", "sysbp", "diasbp", "bmi", "cvd", "afb", "sho", "chf", "av3", "miord", "mitype", "year", "admitdate", "disdate", "fdate", "los", "dstat", "lenfol", "fstat")
# Miro la distribución de seguimiento y estatus final por cohorte.
boxplot(lenfol ~ year, data = data)
table(data$year,data$fstat)
# Creamos una nueva columna con los datos de supervivencia en el formato adecuado.
data$surv <- Surv(data$lenfol, data$fstat)
```
# Ejercicio a)

Creamos la variable age_65, que es la edad centrada en 65 años y creamos el modelo con ella.
```{r}
data$age_65 <- data$age - 65
# Creamos el modelo
modelo1 <- coxph(surv ~ age_65 + gender + age_65*gender, data = data)
# Y comprobamos si todas las variables cumplen con la premisa de riesgos proporcionales
cox.zph(modelo1, transform =  rank)
```
Niguno de los valores de p es significativo, tampoco para todo el modelo, por lo que no podemos rechazar la hipótesis de que todas las variables, y el modelo completo, cumplen la proporcionalidad.



```{r}
summary(modelo1)

```
Como la edad está codificada como (1,0) el riesgo relativo será $\hat{HR}=e^{\hat{\beta}_1} = 1.421$ con un intervalo para el 95% $(0.9280, 2.1748)$. Según estos datos, la probabilidad de que una mujer muera tras un infarto es un 41% mayor que la de un hombre. Tanto el Wald test como el resto de los p-valores son significativos, aunque como dato que puede dejar abierta la puerta a la duda el valor neutro (1) queda dentro del intervalo del 95% (si bien por muy poco).  

# Ejercicio b)

Aádimos ahora el tipo de IM, el orden de IM, la interacción tipo IM-orden IM, el ritmo cardíaco (centrado en 85 pulsaciones por minuto) y el indicador de complicaciones cardíacas.
```{r}
data$hr_85 <- data$hr - 85
# Creamos el modelo
modelo2 <- coxph(surv ~ age_65 + gender + age_65*gender + mitype + miord + mitype*miord + hr_85 + chf, data = data)
summary(modelo2)
### Falta meter el pattern para ver la basal -> ver foro
# pattern <- data.frame()
plot(survfit(modelo2))
```

# Ejercicio c)  

Representamos la función de supervivencia estimada para el modelo del apartado
anterior, para cada tipo IM y orden IM (cuatro posibilidades). 


```{r}
par(2,2)
pattern<- data.frame(miord=0, mitype=0)
plot(survfit(modelo2, newdata=pattern), main = "miord=0, mitype=0")
pattern<- data.frame(miord=0, mitype=1)
plot(survfit(modelo2, newdata=pattern), main = "miord=0, mitype=1")
pattern<- data.frame(miord=1, mitype=0)
plot(survfit(modelo2, newdata=pattern), main = "miord=1, mitype=0")
pattern<- data.frame(miord=1, mitype=1)
plot(survfit(modelo2, newdata=pattern), main = "miord=1, mitype=1")

```


# Ejercicio d)


```{r}
#curvas de supervivencia
# pattern<- data.frame(gender=1, age=65)
# plot(survfit(modelo,newdata=pattern))
# pattern<- data.frame(gender=0, age=65)
# plot(survfit(modelo,newdata=pattern))
```




